<!DOCTYPE html>
<html>

    <!--head{{{-->
    <head>
        <title>scanner 58b0c9d</title>
        <script src="scanner.js"></script>
        <style>
            .space-between {
                display: flex;
                border: 1px solid red;
                justify-content: space-between;
            }
            .button-box {
                display: flex;
                border: 1px solid green;
                align-items: center;
                justify-content: center;
            }
            .canvas-box{
                display: flex;
                border: 1px solid blue;
                justify-content: center;
                margin-right: 30%;
            }
            .result-box{
                display: flex;
                border: 1p solid yellow;
                justify-content: center;
            }
        </style>
    </head>
    <!--}}}-->

    <body>
        <!--div{{{-->
        <div class="space-between">
            <div class="button-box">
                <input type="button" id="cameraSelector" value="Back" style="font-size: 40px;" onclick="toggleValue()"> 
            </div>
            <div class="canvas-box">
                <canvas id="canvas" width="640" height="480" style="border: solid pink 2px;"></canvas>
            </div>
        </div>
        <div id="result" class="result-box"></div>
        <!--}}}-->

        <!--script{{{-->
        <script>
            var zxing = ZXing().then(function (instance) {
                zxing = instance; // this line is supposedly not required but with current emsdk it is :-/
            });

            const cameraSelector = document.getElementById("cameraSelector");
            const mode = document.getElementById("mode");
            const canvas = document.getElementById("canvas");
            const resultElement = document.getElementById("result");

            const ctx = canvas.getContext("2d", { willReadFrequently: true });
            const video = document.createElement("video");
            video.setAttribute("id", "video");
            video.setAttribute("width", canvas.width);
            video.setAttribute("height", canvas.height);
            video.setAttribute("autoplay", "");

            function readBarcodeFromCanvas(canvas) {
                var imgWidth = canvas.width;
                var imgHeight = canvas.height;
                var imageData = canvas.getContext('2d').getImageData(0, 0, imgWidth, imgHeight);
                var sourceBuffer = imageData.data;

                if (zxing != null) {
                    var buffer = zxing._malloc(sourceBuffer.byteLength);
                    zxing.HEAPU8.set(sourceBuffer, buffer);
                    var result = zxing.readBarcodeFromPixmap(buffer, imgWidth, imgHeight);
                    zxing._free(buffer);
                    return result;
                } else {
                    return { error: "ZXing not yet initialized" };
                }
            }

            function drawResult(code) {
                ctx.beginPath();
                ctx.lineWidth = 4;
                ctx.strokeStyle = "red";
                with (code.position) {
                    ctx.moveTo(topLeft.x, topLeft.y);
                    ctx.lineTo(topRight.x, topRight.y);
                    ctx.lineTo(bottomRight.x, bottomRight.y);
                    ctx.lineTo(bottomLeft.x, bottomLeft.y);
                    ctx.lineTo(topLeft.x, topLeft.y);
                    ctx.stroke();
                }
            }

            function escapeTags(htmlStr) {
                return htmlStr.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
            }

            const processFrame = function () {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const code = readBarcodeFromCanvas(canvas);
                if (code.format) {
                    resultElement.innerText = code.format + ": " + escapeTags(code.text);
                    drawResult(code)
                    //} else {
                    //resultElement.innerText = "No barcode found";
                }
                requestAnimationFrame(processFrame);
            };

            const updateVideoStream = function (deviceId) {
                // To ensure the camera switch, it is advisable to free up the media resources
                if (video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());

                navigator.mediaDevices
                    .getUserMedia({ video: { facingMode: deviceId }, audio: false })
                    .then(function (stream) {
                        video.srcObject = stream;
                        video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
                        video.play();
                        processFrame();
                    })
                    .catch(function (error) {
                        console.error("Error accessing camera:", error);
                    });
            };

            function toggleValue(){
                var cam = document.getElementById('cameraSelector').value;
                if (cam == "Front") {
                    updateVideoStream("environment");
                    document.getElementById('cameraSelector').value = "Back";
                }
                if (cam == "Back") {
                    updateVideoStream("user");
                    document.getElementById('cameraSelector').value = "Front";
                }
            }

            updateVideoStream();
        </script>
        <!--}}}-->
    </body>
</html>
