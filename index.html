<!DOCTYPE html>
<html>

    <head>
        <title>price locator</title>
        <script src="scanner.js"></script>
    </head>

    <body style="text-align: center">
        <script>
            function changeValue(o){
                document.getElementById('cameraSelector').value=o;
            }
        </script>
        <input type="button" value="Front" style="font-size : 20px; width: 150px; height: 100%;" onclick="changeValue('user')"> 
        <input type="button" value="Back" style="font-size : 20px; width: 150px; height: 100%;" onclick="changeValue('environment')">
        <input type="hidden" id="cameraSelector" value="user" />

        &nbsp;&nbsp;

        <br /><br />

        <canvas id="canvas" width="640" height="480"></canvas>
        <br /><br />

        <div id="result"></div>

        <script>
            var zxing = ZXing().then(function (instance) {
                zxing = instance; // this line is supposedly not required but with current emsdk it is :-/
            });

            const cameraSelector = document.getElementById("cameraSelector");
            const mode = document.getElementById("mode");
            const canvas = document.getElementById("canvas");
            const resultElement = document.getElementById("result");

            const ctx = canvas.getContext("2d", { willReadFrequently: true });
            const video = document.createElement("video");
            video.setAttribute("id", "video");
            video.setAttribute("width", canvas.width);
            video.setAttribute("height", canvas.height);
            video.setAttribute("autoplay", "");

            function readBarcodeFromCanvas(canvas) {
                var imgWidth = canvas.width;
                var imgHeight = canvas.height;
                var imageData = canvas.getContext('2d').getImageData(0, 0, imgWidth, imgHeight);
                var sourceBuffer = imageData.data;

                if (zxing != null) {
                    var buffer = zxing._malloc(sourceBuffer.byteLength);
                    zxing.HEAPU8.set(sourceBuffer, buffer);
                    var result = zxing.readBarcodeFromPixmap(buffer, imgWidth, imgHeight);
                    zxing._free(buffer);
                    return result;
                } else {
                    return { error: "ZXing not yet initialized" };
                }
            }

            function drawResult(code) {
                ctx.beginPath();
                ctx.lineWidth = 4;
                ctx.strokeStyle = "red";
                with (code.position) {
                    ctx.moveTo(topLeft.x, topLeft.y);
                    ctx.lineTo(topRight.x, topRight.y);
                    ctx.lineTo(bottomRight.x, bottomRight.y);
                    ctx.lineTo(bottomLeft.x, bottomLeft.y);
                    ctx.lineTo(topLeft.x, topLeft.y);
                    ctx.stroke();
                }
            }

            function escapeTags(htmlStr) {
                return htmlStr.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
            }

            const processFrame = function () {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const code = readBarcodeFromCanvas(canvas);
                if (code.format) {
                    resultElement.innerText = code.format + ": " + escapeTags(code.text);
                    drawResult(code)
                    //} else {
                        //resultElement.innerText = "No barcode found";
                    }
                requestAnimationFrame(processFrame);
            };

            const updateVideoStream = function (deviceId) {
                // To ensure the camera switch, it is advisable to free up the media resources
                if (video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());

                navigator.mediaDevices
                    .getUserMedia({ video: { facingMode: deviceId }, audio: false })
                    .then(function (stream) {
                        video.srcObject = stream;
                        video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
                        video.play();
                        processFrame();
                    })
                    .catch(function (error) {
                        console.error("Error accessing camera:", error);
                    });
            };

            cameraSelector.addEventListener("change", function () {
                updateVideoStream(this.value);
            });

            updateVideoStream();
        </script>
    </body>

</html>
